y = volume,
fill = flat_CDM_supertype_name)) +
geom_violin(alpha = .4) +
geom_boxplot(width = .2,
alpha = .6,
fatten = NULL,
show.legend = F) +
stat_summary(fun = "median",
show.legend = F) +
#coord_trans(y = "log10") +
ggtitle(cluster_names[8]) +
scale_fill_manual(values=supertype_color_palette) +
facet_wrap(~tool) +
labs(x = "", y = "cell volume") + # Customize axis labels
theme_minimal() + # Remove x-axis elements
theme(axis.text.x = element_text(angle = 45, hjust = 1))
fixed_name <-  gsub("/", "-", cluster_names[8])
# look at volume distribution
ggsave(filename = paste0("/results/volume_",fixed_name,".pdf"),
plot = plot,
width = 12,
height = 7,
dpi = 300)
subclass_name <- cluster_names[25]
vol_comp_1 <- combined_meta %>%
filter(flat_CDM_subclass_name == subclass_name)
plot <- ggplot(vol_comp_1,
aes(x = flat_CDM_supertype_name,
y = volume,
fill = flat_CDM_supertype_name)) +
geom_violin(alpha = .4) +
geom_boxplot(width = .2,
alpha = .6,
fatten = NULL,
show.legend = F) +
stat_summary(fun = "median",
show.legend = F) +
#coord_trans(y = "log10") +
ggtitle(subclass_name) +
scale_fill_manual(values=supertype_color_palette) +
facet_wrap(~tool) +
labs(x = "", y = "cell volume") + # Customize axis labels
theme_minimal() + # Remove x-axis elements
theme(axis.text.x = element_text(angle = 45, hjust = 1))
fixed_name <-  gsub("/", "-", subclass_name)
# look at volume distribution
ggsave(filename = paste0("/results/volume_",fixed_name,".pdf"),
plot = plot,
width = 12,
height = 7,
dpi = 300)
subclass_name <- cluster_names[69]
vol_comp_1 <- combined_meta %>%
filter(flat_CDM_subclass_name == subclass_name)
plot <- ggplot(vol_comp_1,
aes(x = flat_CDM_supertype_name,
y = volume,
fill = flat_CDM_supertype_name)) +
geom_violin(alpha = .4) +
geom_boxplot(width = .2,
alpha = .6,
fatten = NULL,
show.legend = F) +
stat_summary(fun = "median",
show.legend = F) +
#coord_trans(y = "log10") +
ggtitle(subclass_name) +
scale_fill_manual(values=supertype_color_palette) +
facet_wrap(~tool) +
labs(x = "", y = "cell volume") + # Customize axis labels
theme_minimal() + # Remove x-axis elements
theme(axis.text.x = element_text(angle = 45, hjust = 1))
fixed_name <-  gsub("/", "-", subclass_name)
# look at volume distribution
ggsave(filename = paste0("/results/volume_",fixed_name,".pdf"),
plot = plot,
width = 12,
height = 7,
dpi = 300)
# plot number of cells per section for sis or vpt
summary_data <- combined_meta %>%
group_by(section, tool) %>%
dplyr::summarise(count = n()) %>%
ungroup()
# Create the bar graph
plot <- ggplot(summary_data,
aes(x = fct_rev(section),
y = count,
fill = tool)) +
geom_bar(stat = "identity", position = position_dodge2()) +
labs(title = "Number of cells per section",
x = "Section",
y = "# of high quality cells") +
scale_fill_brewer(palette = "Dark2", name = "Segmentation Tool") +
theme_minimal() + # Remove x-axis elements
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(filename = "/results/cell_per_section.pdf",
plot = plot,
width = 12,
height = 5,
dpi = 300)
summary_data_sis <- combined_meta %>%
filter(tool == "SIS") %>%
group_by(flat_CDM_subclass_name) %>%
dplyr::summarise(count = n()) %>%
ungroup()
# make pie chart
plot <- ggplot(summary_data_sis, aes(x = "", y = count, fill = flat_CDM_subclass_name)) +
geom_bar(stat = "identity", width = 1) +
coord_polar(theta = "y") +
scale_fill_manual(values = subclass_color_palette) +
labs(title = "SIS Segmentation",
x = NULL,
y = NULL) +
theme_void() +
theme(legend.position = "none")
ggsave(filename = "/results/subclass_distribution_sis.pdf",
plot = plot,
width = 6,
height = 6,
dpi = 300)
# plot distribution for VPT
summary_data_vpt <- combined_meta %>%
filter(tool == "VPT") %>%
group_by(flat_CDM_subclass_name) %>%
dplyr::summarise(count = n()) %>%
ungroup()
plot <- ggplot(summary_data_vpt, aes(x = "", y = count, fill = flat_CDM_subclass_name)) +
geom_bar(stat = "identity", width = 1) +
coord_polar(theta = "y") +
scale_fill_manual(values = subclass_color_palette) +
labs(title = "VPT Segmentation",
x = NULL,
y = NULL) +
theme_void() +
theme(legend.position = "none")
ggsave(filename = "/results/subclass_distribution_vpt.pdf",
plot = plot,
width = 6,
height = 6,
dpi = 300)
# merge and calculate ratio
subclass_merge <- merge(summary_data_sis,
summary_data_vpt,
by = "flat_CDM_subclass_name")
subclass_merge$subclass_merge_ratio <- subclass_merge$count.x/subclass_merge$count.y
subclass_merge$absolute_change <- subclass_merge$count.x - subclass_merge$count.y
suppressPackageStartupMessages({
library(dplyr)
library(tibble)
library(tidyr)
library(cowplot)
library(stringr)
library(ggplot2)
library(grid)
library(gridExtra)
library(data.table)
library(rearrr)
library(reticulate)
library(anndata)
})
options(stringsAsFactors = FALSE)
options(scipen=9999)
options(mc.cores=20)
# read in old segmentation
vpt <- read_h5ad("/data/merscope_638850_mouseadult_processed_VPT/whole_dataset/mouse_638850_filtered.h5ad")
suppressPackageStartupMessages({
library(dplyr)
library(tibble)
library(tidyr)
library(cowplot)
library(stringr)
library(ggplot2)
library(grid)
library(gridExtra)
library(data.table)
library(rearrr)
library(reticulate)
library(anndata)
library(ttr)
library(devtools)
library(RColorBrewer)
library(googlesheets4)
library(plyr)
library(ggrastr)
library(forcats)
library(scrattch.vis)
})
options(stringsAsFactors = FALSE)
options(scipen=9999)
options(mc.cores=30)
suppressPackageStartupMessages({
library(dplyr)
library(tibble)
library(tidyr)
library(cowplot)
library(stringr)
library(ggplot2)
library(grid)
library(gridExtra)
library(data.table)
library(rearrr)
library(reticulate)
library(anndata)
})
options(stringsAsFactors = FALSE)
options(scipen=9999)
options(mc.cores=20)
# read in old segmentation
#vpt <- read_h5ad("/data/merscope_638850_mouseadult_processed_VPT/whole_dataset/mouse_638850_filtered.h5ad")
#metadata_vpt <- vpt$obs
#save(metadata_vpt, file = "/scratch/metadata_vpt.rda")
load("/scratch/metadata_vpt.rda")
# read in new segmentation
sis <- read_h5ad("/data/merscope_638850_mouseadult_processed_SIS/")
coordinates_sis <- as.data.frame(coordinates_sis)
# read in new segmentation
sis <- read_h5ad("/data/merscope_638850_mouseadult_processed_SIS/")
suppressPackageStartupMessages({
library(anndata)
library(scrattch.vis)
library(dplyr)
library(tibble)
library(tidyr)
library(ttr)
})
# select marker genes:
# exict:Slc17a7,Slc17a6,Nrn1,
# inhib:Slc32a1,Gad2,
# olig:Sox10,Mog
# astro:Aqp4,Gfap,Glis3,
# immune:Arhgap15,Ctss
# vasc: Igf2,Tbx3
marker_genes <- c("Slc17a7","Slc17a6","Nrn1","Slc32a1","Gad2","Sox10","Mog","Aqp4","Gfap","Glis3","Arhgap15","Ctss","Igf2","Tbx3")
# load anndata file for vpt segmentaiton
vpt <- read_h5ad("/data/merscope_638850_mouseadult_processed_VPT/whole_dataset/mouse_638850_filtered.h5ad")
# extract metadata and keep only cell type assignment
metadata_vpt <- vpt$obs
filtered_metadata_vpt <- metadata_vpt %>%
filter(final_filter == FALSE) %>%
select(CDM_cluster_name,
CDM_supertype_name,
CDM_subclass_name,
CDM_class_name)
# extract count matrix and convert to data frame
data <- vpt$X
data <- as.data.frame(data)
# remove unnecessay datasets to save space
rm(vpt)
rm(metadata_vpt)
# Extract row names from metadata
row_names_to_keep <- rownames(filtered_metadata_vpt)
# Subset count matrix to high quality cells
subset_data <- data[row_names_to_keep, ]
# Subset count martrix to marker genes
marker_genes_data <- subset_data %>%
select(all_of(marker_genes))
# Combine datasets
vpt_data_combined <- merge(filtered_metadata_vpt,
marker_genes_data,
by = 0)
vpt_data_combined$Row.names <- NULL
# Convert from wide to long format using column indices
plot_data_vpt <- vpt_data_combined %>%
pivot_longer(
cols = 5:18,           # Specify the columns to pivot by their indices
names_to = "gene",    # Name of the new key column
values_to = "expression"   # Name of the new value column
)
plot_data_vpt$tool <- "VPT"
rm(vpt_data_combined)
# load anndata file for vpt segmentaiton
sis <- read_h5ad("/data/merscope_638850_mouseadult_processed_SIS/whole_dataset/mouse_638850_filtered.h5ad")
# extract metadata and keep only cell type assignment
metadata_sis <- sis$obs
filtered_metadata_sis <- metadata_sis %>%
filter(final_filter == FALSE) %>%
select(CDM_cluster_name,
CDM_supertype_name,
CDM_subclass_name,
CDM_class_name)
# extract count matrix and convert to data frame
data <- sis$X
data <- as.data.frame(data)
# remove unnecessay datasets to save space
rm(sis)
rm(metadata_sis)
# Extract row names from metadata
row_names_to_keep <- rownames(filtered_metadata_sis)
# Subset count matrix to high quality cells
subset_data <- data[row_names_to_keep, ]
# Subset count martrix to marker genes
marker_genes_data <- subset_data %>%
select(all_of(marker_genes))
# Combine datasets
sis_data_combined <- merge(filtered_metadata_sis,
marker_genes_data,
by = 0)
sis_data_combined$Row.names <- NULL
# Convert from wide to long format using column indices
plot_data_sis <- sis_data_combined %>%
pivot_longer(
cols = 5:18,           # Specify the columns to pivot by their indices
names_to = "gene",    # Name of the new key column
values_to = "expression"   # Name of the new value column
)
plot_data_vpt$tool <- "SIS"
# merge datasets
list_of_dfs <- list(plot_data_vpt, plot_data_sis)
plot_data <- rbindlist(list_of_dfs)
library(data.table)
plot_data <- rbindlist(list_of_dfs)
View(plot_data_vpt)
View(plot_data_sis)
plot_data_vpt$tool <- "SIS"
plot_data_vpt$tool <- "VPT"
plot_data_sis$tool <- "SIS"
# merge datasets
list_of_dfs <- list(plot_data_vpt, plot_data_sis)
plot_data <- rbindlist(list_of_dfs)
View(plot_data)
ggplot(plot_data,
aes(x = CDM_class_name,
y = expression,
fill = tool)) +
geom_split_violin(alpha = .4) +
geom_boxplot(width = .2,
alpha = .6,
fatten = NULL,
show.legend = F) +
stat_summary(fun = "median",
show.legend = F,
position = position_dodge(.2)) +
#coord_trans(y = "log10") +
scale_fill_brewer(palette = "Dark2", name = "Segmentation Tool") +
facet_grid(gene ~ .)
ggplot(plot_data,
aes(x = CDM_class_name,
y = expression,
fill = tool)) +
geom_split_violin(alpha = .4) +
# geom_boxplot(width = .2,
#              alpha = .6,
#              fatten = NULL,
#              show.legend = F) +
stat_summary(fun = "median",
show.legend = F,
position = position_dodge(.2)) +
#coord_trans(y = "log10") +
scale_fill_brewer(palette = "Dark2", name = "Segmentation Tool") +
facet_grid(gene ~ .) +
labs(x = "", y = "# of total mRNA molecules per cell") + # Customize axis labels
theme_minimal() + # Remove x-axis elements
theme(axis.text.x = element_text(angle = 45, hjust = 1))
library(scrattch.vis)
options(stringsAsFactors = FALSE)
options(scipen=9999)
options(mc.cores=30)
anno <- tasic_2016_anno
library(tasic2016data)
suppressPackageStartupMessages({
library(anndata)
library(scrattch.vis)
library(dplyr)
library(tibble)
library(tidyr)
library(ttr)
library(data.table)
library(scrattch.vis)
library(googlesheets4)
})
options(stringsAsFactors = FALSE)
options(scipen=9999)
options(mc.cores=30)
gs4_deauth()
# select marker genes:
# exict:Slc17a7,Slc17a6,Nrn1,
# inhib:Slc32a1,Gad2,
# olig:Sox10,Mog
# astro:Aqp4,Gfap,Glis3,
# immune:Arhgap15,Ctss
# vasc: Igf2,Tbx3
marker_genes <- c("Slc17a7","Slc17a6","Nrn1","Slc32a1","Gad2","Sox10","Mog","Aqp4","Gfap","Glis3","Arhgap15","Ctss","Igf2","Tbx3")
anno <- read_sheet("https://docs.google.com/spreadsheets/d/1T86EppILF-Q97OjJyd4R2FjUmPUrdYBUEbbiXqgWEoE/edit?gid=674473196#gid=674473196",sheet = "cl.df.v9_230722")
anno <- anno %>%
select(cl,
supertype_label,
subclass_label,
class_label)
ColorPalCluster <- read_sheet("https://docs.google.com/spreadsheets/d/1a4URa_t3oc824vjIA8LcyYmJrv0-2Rm7Q5eJq42re2c/edit?gid=1882477354#gid=1882477354", sheet = "clusters")
ColorPalCluster <- ColorPalCluster %>%
select(cl,
cluster_label,
cluster_id,
cluster_color)
ColorPalSupert <- read_sheet("https://docs.google.com/spreadsheets/d/1a4URa_t3oc824vjIA8LcyYmJrv0-2Rm7Q5eJq42re2c/edit?gid=1882477354#gid=1882477354", sheet = "supertypes")
ColorPalSupert <- ColorPalSupert %>%
select(supertype_label,
supertype_id,
supertype_color)
ColorPalSubclass <- read_sheet("https://docs.google.com/spreadsheets/d/1a4URa_t3oc824vjIA8LcyYmJrv0-2Rm7Q5eJq42re2c/edit?gid=1882477354#gid=1882477354", sheet = "subclasses")
ColorPalSubclass <- ColorPalSubclass %>%
select(subclass_label,
subclass_id,
subclass_color)
ColorPalClass <- read_sheet("https://docs.google.com/spreadsheets/d/1a4URa_t3oc824vjIA8LcyYmJrv0-2Rm7Q5eJq42re2c/edit?gid=1882477354#gid=1882477354", sheet = "classes")
ColorPalClass <- ColorPalClass %>%
select(class_label,
class_id,
class_color)
# load anndata file for vpt segmentaiton
vpt <- read_h5ad("/data/merscope_638850_mouseadult_processed_VPT/whole_dataset/mouse_638850_filtered.h5ad")
# extract metadata and keep only cell type assignment
#metadata_vpt <- vpt$obs
load("/scratch/metadata_vpt.rda")
filtered_metadata_vpt <- metadata_vpt %>%
filter(final_filter == FALSE) %>%
select(flat_CDM_cluster_alias)
# Convert row names into a column
filtered_metadata_vpt <- rownames_to_column(filtered_metadata_vpt, var = "sample_name")
filtered_metadata_vpt <- merge(filtered_metadata_vpt,
anno,
by.x = "flat_CDM_cluster_alias",
by.y = "cl",
all.x = T,
all.y = F)
filtered_metadata_vpt <- merge(filtered_metadata_vpt,
ColorPalCluster,
by.x = "flat_CDM_cluster_alias",
by.y = "cl",
all.x = T,
all.y = F)
filtered_metadata_vpt <- merge(filtered_metadata_vpt,
ColorPalSupert,
by = "supertype_label",
all.x = T,
all.y = F)
filtered_metadata_vpt <- merge(filtered_metadata_vpt,
ColorPalSubclass,
by = "subclass_label",
all.x = T,
all.y = F)
filtered_metadata_vpt <- merge(filtered_metadata_vpt,
ColorPalClass,
by = "class_label",
all.x = T,
all.y = F)
# extract count matrix and convert to data frame
data_vpt <- vpt$X
data_vpt <- as.data.frame(data_vpt)
# Convert row names into a column
data_vpt <- rownames_to_column(data_vpt, var = "sample_name")
save(data_vpt, file = "/scratch/data_vpt.rda")
# extract count matrix and convert to data frame
# data_vpt <- vpt$X
# data_vpt <- as.data.frame(data_vpt)
# Convert row names into a column
# data_vpt <- rownames_to_column(data_vpt, var = "sample_name")
# save(data_vpt, file = "/scratch/data_vpt.rda")
load("/scratch/data_vpt.rda")
# remove unnecessay datasets to save space
rm(vpt)
# Extract row names from metadata
cells_to_keep <- filtered_metadata_vpt$sample_name
# Subset count matrix to high quality cells
subset_data_vpt <- data_vpt %>%
filter(sample_name %in% cells_to_keep)
# Subset count martrix to marker genes
marker_genes_data <- subset_data_vpt %>%
select(sample_name,
all_of(marker_genes))
plot_anno_vpt <-  filtered_metadata_vpt %>%
filter(subclass_label == "Sncg Gaba")
plot_data_vpt <- subset_data_vpt %>%
filter(sample_name %in% plot_anno_vpt$sample_name)
group_violin_plot(subset_data_vpt,
filtered_metadata_vpt,
genes = c("Slc17a7","Slc17a6","Nrn1",
"Slc32a1","Gad2",
"Sox10","Mog",
"Aqp4","Gfap","Glis3",
"Igf2","Tbx3",
"Arhgap15","Ctss"),
grouping = "class",
log_scale = FALSE,
font_size = 5,
rotate_counts = TRUE)
sample_fire_plot(subset_data_vpt,
filtered_metadata_vpt,
genes = c("Slc17a7","Slc17a6","Nrn1",
"Slc32a1","Gad2",
"Sox10","Mog",
"Aqp4","Gfap","Glis3",
"Igf2","Tbx3",
"Arhgap15","Ctss"),
grouping = "class",
log_scale = TRUE,
top_value = "lowest",
font_size = 8)
group_heatmap_plot(subset_data_vpt,
filtered_metadata_vpt,
genes = c("Slc17a7","Slc17a6","Nrn1",
"Slc32a1","Gad2",
"Sox10","Mog",
"Aqp4","Gfap","Glis3",
"Igf2","Tbx3",
"Arhgap15","Ctss"),
grouping = "class",
stat = "tmean",
log_scale = TRUE,
font_size = 8,
rotate_counts = TRUE)
